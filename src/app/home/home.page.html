<ion-content [fullscreen]="true" class="page">
  <section class="hero">
    <img src="assets/crypto-coin-logo.png" alt="Crypto Coin" class="hero__logo" />
    <h1 class="hero__title">Crypto Coin</h1>
    <p class="hero__subtitle">Offline ColdWallet</p>
    <p class="hero__description">Proteja suas chaves cripto com tecnologia NFC</p>
  </section>

  <section class="main" id="content">
    <section class="tool-card">
      <h3 class="tool-card__title">Gerenciar Dados</h3>
      <p class="tool-card__text">As chaves são criptografadas automaticamente assim que você informa a frase de recuperação e a senha.</p>

      <div class="form-group textarea-group">
        <label for="seedPhrase">Frase de Recuperação</label>
        <textarea
          id="seedPhrase"
          [(ngModel)]="seedPhrase"
          (ngModelChange)="onSeedPhraseChange()"
          rows="3"
          placeholder="Digite aqui sua seed phrase">
        </textarea>
        <button
          type="button"
          class="icon-button"
          (click)="copySeedPhrase()"
          [disabled]="!seedPhrase">
          <ion-icon name="copy-outline"></ion-icon>
        </button>
      </div>

      <div class="form-row">
        <div class="form-group textarea-group">
          <label for="password">Senha</label>
          <input
            #passwordInput
            id="password"
            type="password"
            [(ngModel)]="password"
            (ngModelChange)="onPasswordChange()"
            placeholder="Informe a senha" />
          <button
            type="button"
            class="icon-button"
            (click)="togglePasswordVisibility()">
            <ion-icon [name]="passwordVisible ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
          </button>
        </div>
        <div class="form-group textarea-group">
          <label for="encrypted">Dados Criptografados</label>
          <textarea
            id="encrypted"
            [(ngModel)]="encryptedPayload"
            (ngModelChange)="onEncryptedPayloadInput()"
            rows="3"
            placeholder="Resultado da criptografia ou leitura">
          </textarea>
          <button
            type="button"
            class="icon-button"
            (click)="copyEncryptedPayload()"
            [disabled]="!encryptedPayload">
            <ion-icon name="copy-outline"></ion-icon>
          </button>
        </div>
      </div>

      <div class="encryption-controls">
        <mat-form-field appearance="fill" class="algorithm-select">
          <mat-label>Algoritmo</mat-label>
          <mat-select
            [value]="encryptionMode"
            (selectionChange)="onAlgorithmChange($event.value)"
            panelClass="algorithm-select__panel">
            @for (option of encryptionOptions; track option.id) {
              <mat-option [value]="option.id">
                <div class="algorithm-option">
                  <span class="algorithm-option__label">{{ option.label }}</span>
                  <span class="algorithm-option__description">{{ option.description }}</span>
                </div>
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <div class="compression-toggle">
          <label for="compressionToggle">Compactação</label>
          <ion-toggle
            id="compressionToggle"
            [checked]="compressionEnabled"
            (ionChange)="onCompressionChange($event.detail.checked)">
          </ion-toggle>
        </div>
      </div>

      <div class="variant-metrics">
        <div class="variant-metrics__item" [class.variant-metrics__item--active]="!compressionEnabled">
          <span class="variant-metrics__label">Sem compactação</span>
          <span class="variant-metrics__value">{{ formatBytes(encryptionMode, false) }}</span>
        </div>
        <div class="variant-metrics__item" [class.variant-metrics__item--active]="compressionEnabled">
          <span class="variant-metrics__label">Com compactação</span>
          <span class="variant-metrics__value">{{ formatBytes(encryptionMode, true) }}</span>
        </div>
      </div>

      @if (encryptedPreviewBytes !== null) {
        <div class="preview-line">
          <strong>Seleção atual:</strong>
          <span>{{ selectedEncryptionOption?.label }}</span>
          @if (compressionEnabled) {
            <span>+ compactação</span>
          }
          <span>• {{ encryptedPreviewBytes }} bytes</span>
        </div>
      }
      @if (!seedPhrase || !password) {
        <div class="preview-line">
          <span>Informe frase e senha para estimar o tamanho em cada opção.</span>
        </div>
      }
      @if (encryptionError) {
        <div class="error-line">{{ encryptionError }}</div>
      }

      <div class="toggle-row">
        <label for="autoVerify">Verificar gravação automaticamente</label>
        <ion-toggle id="autoVerify" [(ngModel)]="autoVerifyWrite"></ion-toggle>
      </div>

      <div class="tool-actions">
        <button type="button" class="btn btn--outline" (click)="readFromNFC()">Ler Tag NFC</button>
        <button type="button" class="btn btn--solid" (click)="writeToNFC()">Escrever Tag NFC</button>
      </div>
    </section>

    <section class="security-card">
      <header class="security-card__header">
        <ion-icon name="shield-half-outline"></ion-icon>
        <div>
          <h3>Segurança Offline</h3>
          <p>Proteção completa para suas chaves e tags NFC</p>
        </div>
      </header>
      <ul class="security-list">
        <li>
          <ion-icon name="lock-closed-outline"></ion-icon>
          <div>
            <strong>Criptografia AES-256</strong><br>
            <span>Suas chaves são protegidas com criptografia militar</span>
          </div>
        </li>
        <li>
          <ion-icon name="cloud-offline-outline"></ion-icon>
          <div>
            <strong>100% Offline</strong><br>
            <span>Nenhum dado é transmitido pela internet</span>
          </div>
        </li>
        <li>
          <ion-icon name="radio-outline"></ion-icon>
          <div>
            <strong>Tecnologia NFC</strong><br>
            <span>Armazenamento físico em tags NFC</span>
          </div>
        </li>
        <li class="security-list__opensource">
          <ion-icon name="code-slash"></ion-icon>
          <div>
            <strong>Open Source</strong><br>
            <span>Projeto aberto que pode ser compilado, testado e melhorado por qualquer pessoa.</span><br>
            <a class="repo-link" href="https://github.com/ReservaDevOps/CryptoCoin" target="_blank" rel="noopener noreferrer">
              <ion-icon name="logo-github"></ion-icon>
              Ver no GitHub
            </a>
          </div>
        </li>
      </ul>
    </section>
  </section>

  <ion-modal [isOpen]="isReadModalOpen" class="instruction-modal" [backdropDismiss]="false">
    <div class="modal-content">
      <div class="modal-graphic" [class.modal-graphic--success]="showReadSuccess">
        <ion-icon [name]="showReadSuccess ? 'checkmark-circle-outline' : 'radio'"></ion-icon>
      </div>
      <h2>{{ showReadSuccess ? 'Tag detectada!' : 'Aproxime a tag NFC' }}</h2>
      <p>
        {{ showReadSuccess ? 'Leitura concluída com sucesso. Você já pode descriptografar e copiar sua seed.' : 'Aproxime o dispositivo da tag NFC até sentir a vibração ou ver a confirmação na tela.' }}
      </p>
      @if (showReadSuccess) {
        <ion-button fill="clear" size="small" (click)="closeReadModal()">Concluir</ion-button>
      }
    </div>
  </ion-modal>

  <ion-modal [isOpen]="isWriteModalOpen" class="instruction-modal" [backdropDismiss]="false">
    <div class="modal-content">
      <div class="modal-graphic" [class.modal-graphic--success]="showWriteSuccess">
        <ion-icon [name]="showWriteSuccess ? 'checkmark-circle-outline' : 'radio'"></ion-icon>
      </div>
      <h2>
        {{ showWriteSuccess ? 'Dados gravados!' : verificationInProgress ? 'Verificando gravação' : 'Aproxime a tag NFC' }}
      </h2>
      @if (verificationMessage) {
        <p>{{ verificationMessage }}</p>
      } @else {
        <p>Encoste a tag NFC no dispositivo e mantenha-a próxima até a gravação finalizar.</p>
      }
      @if (showWriteSuccess) {
        <ion-button fill="clear" size="small" (click)="closeWriteModal()">Concluir</ion-button>
      } @else if (!verificationInProgress) {
        <ion-button fill="clear" size="small" (click)="closeWriteModal()">Fechar</ion-button>
      }
    </div>
  </ion-modal>
</ion-content>
